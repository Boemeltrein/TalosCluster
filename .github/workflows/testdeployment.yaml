name: HelmRelease test deployment

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "**/helm-release.yaml"

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Detect changed HelmReleases
        id: set
        run: |
          files=$(git diff \
            "${{ github.event.pull_request.base.sha }}" \
            "${{ github.sha }}" \
            --name-only | grep 'helm-release.yaml$' || true)
          
          if [ -z "$files" ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          json=$(printf '%s\n' "$files" | jq -R . | jq -s .)
          
          {
            echo "matrix<<EOF"
            echo "$json"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  test:
    needs: detect
    if: needs.detect.outputs.matrix != '[]'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        helmrelease: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      # --------------------------------------------------
      # Checkout repo
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      # --------------------------------------------------
      # Install required CLI tools
      # --------------------------------------------------
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gettext
          curl -sSL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 \
            -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      # --------------------------------------------------
      # Dummy env vars for Helm interpolation
      # --------------------------------------------------
      - name: Set dummy env vars
        run: |
          echo "BASE_DOMAIN=base.dummy.local" >> "$GITHUB_ENV"
          echo "DOMAIN=dummy.local" >> "$GITHUB_ENV"
          echo "S3_URL=dummy" >> "$GITHUB_ENV"
          echo "S3_ACCESKEY=dummy123456789" >> "$GITHUB_ENV"
          echo "S3_SECRETKEY=dummy123456789" >> "$GITHUB_ENV"
          echo "S3_ENCRKEY=dummy123456789" >> "$GITHUB_ENV"

      # --------------------------------------------------
      # Create ephemeral k3d cluster
      # --------------------------------------------------
      - name: Create k3d cluster
        uses: nolar/setup-k3d-k3s@v1
        with:
          version: latest
          k3d-args: --k3s-arg --disable=metrics-server@server:*
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove node taints
        run: |
          kubectl taint --all=true nodes node.cloudprovider.kubernetes.io/uninitialized- || true

      - name: Install kubectl
        uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede # v4

      - name: Install helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4

      # --------------------------------------------------
      # Deploy & test HelmRelease
      # --------------------------------------------------
      - name: Test HelmRelease
        run: |
          chmod +x .github/scripts/deploy_helmrelease.sh
          echo "=============================================="
          echo "=== Testing ${{ matrix.helmrelease }} ==="
          echo "=============================================="
          bash .github/scripts/deploy_helmrelease.sh "${{ matrix.helmrelease }}"
