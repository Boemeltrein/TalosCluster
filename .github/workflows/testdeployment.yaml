name: HelmRelease test deployment

on:
  pull_request:
    paths:
      - "**/helm-release.yaml"

jobs:
  test-helmreleases:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout (FULL history for PR diff)
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Install required tools
      # --------------------------------------------------
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -sSL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 \
            -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      # --------------------------------------------------
      # Dummy env vars (Helm value interpolation)
      # --------------------------------------------------
      - name: Set dummy env vars
        run: |
          echo "BASE_DOMAIN=example.local" >> "$GITHUB_ENV"
          echo "S3_URL=dummy" >> "$GITHUB_ENV"
          echo "S3_ACCESKEY=dummy" >> "$GITHUB_ENV"
          echo "S3_SECRETKEY=dummy" >> "$GITHUB_ENV"
          echo "S3_ENCRKEY=dummy" >> "$GITHUB_ENV"

      # --------------------------------------------------
      # Create ephemeral Kubernetes cluster
      # --------------------------------------------------
      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: pr-test

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install helm
        uses: azure/setup-helm@v4

      # --------------------------------------------------
      # Detect changed HelmReleases (SAFE PR diff)
      # --------------------------------------------------
      - name: Detect changed HelmReleases
        id: changes
        run: |
          git diff \
            "${{ github.event.pull_request.base.sha }}" \
            "${{ github.sha }}" \
            --name-only \
            | grep 'helm-release.yaml$' > helmreleases.txt || true

          if [ -s helmreleases.txt ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            cat helmreleases.txt
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # --------------------------------------------------
      # Test deploy HelmReleases
      # --------------------------------------------------
      - name: Test HelmReleases
        if: steps.changes.outputs.changed == 'true'
        run: |
          set -euo pipefail

          while read -r HELMRELEASE; do
            echo "=== Testing $HELMRELEASE ==="

            RELEASE_NAME="$(yq '.metadata.name' "$HELMRELEASE")"
            NAMESPACE="$(yq '.metadata.namespace' "$HELMRELEASE")"
            CHART_NAME="$(yq '.spec.chart.spec.chart' "$HELMRELEASE")"
            CHART_VERSION="$(yq '.spec.chart.spec.version' "$HELMRELEASE")"
            REPO_NAME="$(yq '.spec.chart.spec.sourceRef.name' "$HELMRELEASE")"

            REPO_FILE="$(grep -rl "kind: HelmRepository" . \
              | xargs yq -r 'select(.metadata.name == "'"$REPO_NAME"'") | input_filename' \
              | head -n 1)"

            if [ -z "$REPO_FILE" ]; then
              echo "❌ HelmRepository $REPO_NAME not found in repo"
              exit 1
            fi

            REPO_URL="$(yq '.spec.url' "$REPO_FILE")"

            echo "Chart: $CHART_NAME@$CHART_VERSION"
            echo "Repo:  $REPO_URL"

            # ------------------------------------------------
            # Extract Helm values
            # ------------------------------------------------
            yq '.spec.values' "$HELMRELEASE" > values.generated.yaml

            # ------------------------------------------------
            # Write test overrides (NO heredoc)
            # ------------------------------------------------
            printf '%s\n' \
              'ingress:' \
              '  enabled: false' \
              '' \
              'persistence:' \
              '  enabled: false' \
              '' \
              'resources:' \
              '  requests:' \
              '    cpu: 10m' \
              '    memory: 64Mi' \
              '  limits:' \
              '    memory: 256Mi' \
              > values.test.yaml

            helm repo add test-repo "$REPO_URL"
            helm repo update

            helm upgrade --install "$RELEASE_NAME" "test-repo/$CHART_NAME" \
              --version "$CHART_VERSION" \
              --namespace "$NAMESPACE" \
              --create-namespace \
              --values values.generated.yaml \
              --values values.test.yaml \
              --wait \
              --timeout 10m

            kubectl wait pod \
              --all \
              --for=condition=Ready \
              -n "$NAMESPACE" \
              --timeout=300s

            echo "✔ $RELEASE_NAME OK"
          done < helmreleases.txt

      # --------------------------------------------------
      # Cleanup
      # --------------------------------------------------
      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name pr-test
