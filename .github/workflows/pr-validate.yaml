name: "Pull Request: Validate"

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.head_ref }}-pr-validate
  # cancel-in-progress: true  
  
env:
  KUBERNETES_DIR: ./clusters/main/kubernetes

jobs:
  kubeconform:
    name: Kubeconform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - name: Setup Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Setup Workflow Tools
        run: brew install fluxcd/tap/flux kubeconform kustomize
      - name: Run kubeconform
        shell: bash
        run: bash ./scripts/kubeconform.sh ${{ env.KUBERNETES_DIR }}


  test:
    name: Flux Local - Test
    runs-on: ubuntu-latest
    steps:
      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@534684601ec8888beb0cc4f51117b59e97606c4d # v2.2.3
      - uses: allenporter/flux-local/action/test@4.3.1
        with:
          path: ${{ env.KUBERNETES_DIR }}
          enable-helm: true