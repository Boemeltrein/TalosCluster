apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: seafile
  namespace: seafile
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 15.36.1
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
      interval: 15m
  timeout: 20m
  maxHistory: 3
  driftDetection:
    mode: warn
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  
  values:
    TZ: Europe/Amsterdam
    
    ingress:
      main:
        enabled: true
        ingressClassName: internal
        hosts:
          - host: sea.${BASE_DOMAIN}
        integrations:
          certManager:
            enabled: true
            certificateIssuer: cloudflare

    image:
      repository: docker.io/seafileltd/seafile-mc
      tag: 13.0.18@sha256:d9a472513b826eb9c807caa52faccabc8b65a97ccbc806d98968aaea8dc0d79f
      pullPolicy: IfNotPresent

    service:
      main:
        ports:
          main:
            port: 80
            protocol: http

    securityContext:
      container:
        readOnlyRootFilesystem: false
        runAsNonRoot: false
        runAsUser: 0
        runAsGroup: 0

    workload:
      main:
        podSpec:
          containers:
            main:
              env:
                # sectrets
                JWT_PRIVATE_KEY: "a_very_very_very_very_secret_key"
                SEAFILE_MYSQL_DB_PASSWORD: "{{ .Values.mariadb.password }}"
                INIT_SEAFILE_ADMIN_PASSWORD: "a_very_secret_password"
                INIT_SEAFILE_MYSQL_ROOT_PASSWORD: "{{ .Values.mariadb.rootPassword }}"
                REDIS_PASSWORD: "{{ .Values.redis.password }}"
                
                # for Seafile server
                TIME_ZONE: "UTC"
                SEAFILE_LOG_TO_STDOUT: "true"
                SITE_ROOT: "/"
                SEAFILE_SERVER_HOSTNAME: "sea.${BASE_DOMAIN}"
                SEAFILE_SERVER_PROTOCOL: "https"       


                # for database
                SEAFILE_MYSQL_DB_HOST: 
                  secretKeyRef:
                    expandObjectName: false
                    name: '{{ printf "%s-%s" .Release.Name "mariadbcreds" }}'
                    key: plainhost
                SEAFILE_MYSQL_DB_PORT: "3306"
                SEAFILE_MYSQL_DB_USER: "seafile"
                SEAFILE_MYSQL_DB_CCNET_DB_NAME: "ccnet_db"
                SEAFILE_MYSQL_DB_SEAFILE_DB_NAME: "seafile_db"
                SEAFILE_MYSQL_DB_SEAHUB_DB_NAME: "seahub_db"

                # for cached
                CACHE_PROVIDER: "redis"

                ## for redis
                REDIS_HOST:
                  secretKeyRef:
                    expandObjectName: false
                    name: '{{ printf "%s-%s" .Release.Name "rediscreds" }}'
                    key: plainhost    
                REDIS_PORT: "6379"

                # for notification
                ENABLE_NOTIFICATION_SERVER: "false"
                NOTIFICATION_SERVER_URL: ""

                # for seadoc
                ENABLE_SEADOC: "false"
                SEADOC_SERVER_URL: "" # only valid in ENABLE_SEADOC = true

                # Seafile AI
                ENABLE_SEAFILE_AI: "false"
                SEAFILE_AI_SERVER_URL: "<required when ENABLE_SEAFILE_AI=true>"

                # Matedata server
                MD_FILE_COUNT_LIMIT: "100000"

                # Init
                ## for Seafile admin
                INIT_SEAFILE_ADMIN_EMAIL: "me@example.com"            

    configmap:
      env:
        enabled: true
        data:
          env: |
            JWT_PRIVATE_KEY=a_very_very_very_very_secret_key
            SEAFILE_MYSQL_DB_PASSWORD={{ .Values.mariadb.password }}
            REDIS_PASSWORD={{ .Values.redis.password }}
            SEAFILE_MYSQL_DB_HOST=seafile-mariadb 
            SEAFILE_MYSQL_DB_PORT=3306
            SEAFILE_MYSQL_DB_USER=seafile
            SEAFILE_MYSQL_DB_CCNET_DB_NAME=ccnet_db
            SEAFILE_MYSQL_DB_SEAFILE_DB_NAME=seafile_db
            SEAFILE_MYSQL_DB_SEAHUB_DB_NAME=seahub_db
            TIME_ZONE=UTC
            SEAFILE_LOG_TO_STDOUT=true
            SITE_ROOT=/
            SEAFILE_SERVER_HOSTNAME=sea.${BASE_DOMAIN}
            SEAFILE_SERVER_PROTOCOL=https
            CACHE_PROVIDER=redis
            REDIS_HOST=seafile-redis
            REDIS_PORT=6379
  
  ## {{ printf "%v-%v" .Release.Name "redis" }}
  ## {{ printf "%v-%v" .Release.Name "mariadb" }} 
  
    persistence:
      storage:
        enabled: true
        mountPath: "/shared/seafile"
      env:
        enabled: true
        type: configmap
        objectName: env
        expandObjectName: true
        optional: false
        defaultMode: "0777"
        items:
          - key: env
            path: env
        targetSelector:
          main:
            main:
              mountPath: /shared/seafile/conf/.env
              subPath: env

    mariadb:
      enabled: true

    redis:
      enabled: true