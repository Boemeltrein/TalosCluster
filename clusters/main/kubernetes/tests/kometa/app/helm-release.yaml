apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kometa
  namespace: kometa
spec:
  interval: 15m
  chart:
    spec:
      chart: kometa
      version: 4.15.1
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
      interval: 15m
  timeout: 20m
  maxHistory: 3
  driftDetection:
    mode: warn
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  
  values:
    image:
      repository: ghcr.io/trueforge-org/kometa
      tag: sandbox@sha256:25ec3356c785bc463b2c142abea5665b9fd505416255ecd02bf0aff072246c65
      pullPolicy: IfNotPresent

    service:
      main:
        enabled: false
        ports:
          main:
            enabled: false

    kometa:
      run: false
      no_countdown: true
      time:
        - "00:00"
      # plex_url: ""
      # plex_token: ""

    workload:
      main:
        podSpec:
          initContainers:
            create-init-config-file:
              enabled: true
              type: init
              imageSelector: "image"
              command:
                - /bin/sh
                - -c
              args:
                - |
                  echo "Creating config.yml file..."
                  if [ -f /app/config/config.yml ]; then
                    echo "Config file exists! Skipping..."
                  else
                    echo "Config file is missing, getting a new one!"
                    curl -fLvo /app/config/config.yml https://raw.githubusercontent.com/kometa-team/kometa/master/config/config.yml.template || (echo "Downloading config file, FAILED..." && exit 1)
                  fi
          containers:
            main:
              probes:
                liveness:
                  enabled: false
                readiness:
                  enabled: false
                startup:
                  enabled: false
              envFrom:
                - secretRef:
                    name: "secret"

    persistence:
      config:
        enabled: true
        mountPath: /app/config
        targetSelectAll: true

